---
date: 2024-06-13
draft: false
title: Range Search
categories:
    - COMP90077
tags: 
    - Data Structure
---

- 用于范围查询（一次多个值）

对于二维数据：

- 构建时间：O(n log n)
- 空间消耗：O(n log n)，log n层，每层至多n个
- 查询时间：O(k + log n)，其中 k 是报告的点的数量。

## 查询算法

给定一个查询范围 Q = [a1, b1] × [a2, b2]，我们可以通过以下步骤报告所有在 P ∩ Q 中的点：

1. 在 Tx 中找到 a' = succ(a1) 和 b' = pred(b1)；
2. 让 usplit = LCA(a', b')，La1 是从 usplit 的左孩子到 a' 的路径，Lb1 是从 usplit 的右孩子到 b' 的路径；
3. 如果 usplit ∈ Q，报告 usplit；
4. 对于路径 La1 上的每个节点 u：
   - 如果 u ∈ Q，报告 u；
   - 如果 a' ≤ u.x，那么报告 u 的右子树中所有 y 坐标在 [a2, b2] 范围内的点；
5. 对于路径 Lb1 上的每个节点 u：
   - 如果 u ∈ Q，报告 u；
   - 如果 b' ≥ u.x，那么报告 u 的左子树中所有 y 坐标在 [a2, b2] 范围内的点。

这个算法的基本思想是首先在 x 轴上找到查询范围的边界，然后在这个范围内的每个节点上进行 y 轴的范围搜索。这是一个有效的方法，因为它可以利用二维空间的结构来减少搜索的复杂性。

在开始时，我们承诺可以在 $O(k + \log n)$ 时间内完成二维轴平行矩形范围查询。然而，当前的查询成本是 $O(k + \log^2 n)$，这违反了我们的承诺。

为了将查询时间从 $O(k + \log^2 n)$ 降低到 $O(k + \log n)$，我们需要应用一种称为分数级联（Fractional Cascading）的技术。

分数级联是一种用于优化多层次数据结构查询的技术。通过在每一层都保留一部分信息，我们可以避免在每一层都进行完全的二分查找，从而将查询时间从 $\log^2 n$ 降低到 $\log n$。这种技术在处理二维范围查询、最近邻查询等问题时非常有用。

## Fractional Cascading

分数级联是一种技术，用于加速范围查询。它通过在不同层次的数据结构之间共享信息来减少查询时间。

succ和pred指针，指向下一层的元素。

这段文字是在描述如何通过应用分数级联（Fractional Cascading）技术来优化二维轴平行矩形范围查询的时间复杂度。

基于上述观察，我们可以将所有的次级树替换为排序数组，并应用分数级联技术，以将 $O(k + \log^2 n)$ 的查询时间降低到 $O(\log n + k + \log n) = O(k + \log n)$。

分数级联的基本思想是在每一层的数据结构中保留一部分信息，以便在查询时可以快速定位到下一层的查询位置，从而避免在每一层都进行完全的二分查找。在这个上下文中，我们将次级树替换为排序数组，然后在每个数组中保留一部分信息，以便在查询时可以快速定位到下一个数组的查询位置。

这种方法可以将查询时间从 $O(k + \log^2 n)$ 降低到 $O(k + \log n)$，从而满足我们在开始时的承诺。

## 实现

在范围树中实现分数级联（Fractional Cascading）可以有效地减少查询时间。以下是一个简单的实现步骤：

1. 在构建范围树时，每个节点都存储其子节点的最大和最小值。这样，我们可以快速确定一个查询范围是否与一个子树有交集。

2. 对于每个节点，我们在其左右子节点中存储一个指向其父节点的指针。这样，我们可以从一个子节点快速跳转到其父节点。

3. 当我们进行范围查询时，我们首先在树的根节点开始。我们检查查询范围是否与左右子树有交集。如果有交集，我们就跟踪这个子树，并更新查询范围以排除已经检查过的部分。

4. 当我们跟踪一个子树时，我们使用存储在节点中的指针，快速跳转到其父节点。然后，我们重复步骤3，直到我们检查了所有与查询范围有交集的子树。

5. 最后，我们返回所有在查询范围内的节点。

通过这种方式，我们可以在 O(log n + k) 的时间内完成查询，其中 n 是树中的节点数量，k 是查询返回的节点数量。这比没有使用分数级联的 O(n log n + k) 快得多。
